# =============================================================================
# GunderGrill - Home Assistant Lovelace Dashboard
# =============================================================================
#
# A polished, comprehensive dashboard for monitoring and controlling
# the GunderGrill ESP32 pellet smoker.
#
# Required HACS Frontend Plugins:
#   - mushroom (mushroom-entity-card, mushroom-chips-card, etc.)
#   - apexcharts-card
#   - mini-graph-card
#   - stack-in-card
#   - card-mod
#   - button-card
#
# Installation:
#   1. Install required HACS plugins (see README.md)
#   2. In HA → Settings → Dashboards → Add Dashboard → choose YAML mode
#   3. Point the dashboard YAML path to this file
#   OR:
#   1. Go to an existing dashboard → Edit → Raw Configuration Editor
#   2. Paste the contents of this file
#
# =============================================================================

title: GunderGrill
views:
  - title: Smoker
    path: smoker
    icon: mdi:grill
    type: sections
    max_columns: 4
    cards: []
    sections:

      # =====================================================================
      # SECTION 1: STATUS HEADER
      # =====================================================================
      - title: ""
        type: grid
        cards:

          # Status chips bar
          - type: custom:mushroom-chips-card
            alignment: center
            chips:

              - type: entity
                entity: sensor.gundergrill_state
                icon: mdi:grill
                use_entity_picture: false
                content_info: name
                card_mod:
                  style: |
                    ha-card {
                      {% set state = states('sensor.gundergrill_state') %}
                      {% if state == 'Running' %}
                        --chip-background: rgba(76, 175, 80, 0.2);
                        --chip-icon-color: #4CAF50;
                      {% elif state == 'Startup' %}
                        --chip-background: rgba(255, 152, 0, 0.2);
                        --chip-icon-color: #FF9800;
                      {% elif state == 'Error' %}
                        --chip-background: rgba(244, 67, 54, 0.2);
                        --chip-icon-color: #F44336;
                      {% elif state == 'Cooldown' %}
                        --chip-background: rgba(33, 150, 243, 0.2);
                        --chip-icon-color: #2196F3;
                      {% else %}
                        --chip-background: rgba(158, 158, 158, 0.15);
                      {% endif %}
                    }

              - type: entity
                entity: sensor.gundergrill_temperature
                icon: mdi:thermometer

              - type: conditional
                conditions:
                  - condition: state
                    entity: binary_sensor.gundergrill_active
                    state: "on"
                chip:
                  type: entity
                  entity: sensor.gundergrill_setpoint
                  icon: mdi:target

              - type: entity
                entity: sensor.gundergrill_wifi_quality
                icon: mdi:wifi

      # =====================================================================
      # SECTION 2: TEMPERATURE DISPLAY
      # =====================================================================
      - title: Temperature
        type: grid
        cards:

          # Large temperature display with radial gauge
          - type: custom:apexcharts-card
            header:
              show: true
              title: Grill Temperature
              show_states: true
              colorize_states: true
            chart_type: radialBar
            apex_config:
              chart:
                height: 280
              plotOptions:
                radialBar:
                  startAngle: -135
                  endAngle: 135
                  hollow:
                    size: "60%"
                  track:
                    background: var(--card-background-color)
                    strokeWidth: "80%"
                    margin: 5
                  dataLabels:
                    name:
                      show: true
                      fontSize: "14px"
                      offsetY: -10
                    value:
                      show: true
                      fontSize: "32px"
                      formatter: |
                        EVAL:function(val) {
                          return (val * 500 / 100).toFixed(0) + "°F";
                        }
              fill:
                type: gradient
                gradient:
                  shade: dark
                  type: horizontal
                  shadeIntensity: 0.5
                  gradientToColors:
                    - "#F44336"
                  stops:
                    - 0
                    - 100
            series:
              - entity: sensor.gundergrill_temperature
                name: Current
                color: "#FF9800"
                max: 500
                min: 0
                show:
                  in_header: true

          # Setpoint control
          - type: custom:mushroom-number-card
            entity: number.gundergrill_target_temperature
            name: Target Temperature
            icon: mdi:thermometer-lines
            display_mode: slider
            layout: horizontal
            card_mod:
              style: |
                ha-card {
                  --primary-color: #FF9800;
                }

          # Temperature delta indicator
          - type: custom:mushroom-entity-card
            entity: sensor.gundergrill_temperature_delta
            name: "Temp vs Target"
            icon: >
              {% set delta = states('sensor.gundergrill_temperature_delta') | float(0) %}
              {% if delta > 5 %}mdi:thermometer-chevron-up
              {% elif delta < -5 %}mdi:thermometer-chevron-down
              {% else %}mdi:thermometer-check
              {% endif %}
            layout: horizontal
            card_mod:
              style: |
                ha-card {
                  {% set delta = states('sensor.gundergrill_temperature_delta') | float(0) %}
                  {% if delta | abs < 5 %}
                    --card-primary-color: #4CAF50;
                  {% elif delta > 0 %}
                    --card-primary-color: #F44336;
                  {% else %}
                    --card-primary-color: #2196F3;
                  {% endif %}
                }

      # =====================================================================
      # SECTION 3: TEMPERATURE HISTORY CHART
      # =====================================================================
      - title: Temperature History
        type: grid
        cards:

          - type: custom:apexcharts-card
            header:
              show: true
              title: Temperature History
              show_states: true
              colorize_states: true
            graph_span: 4h
            apex_config:
              chart:
                height: 300
              stroke:
                width:
                  - 3
                  - 2
                curve:
                  - smooth
                  - stepline
              yaxis:
                - id: temp
                  min: 100
                  max: 400
                  decimalsInFloat: 0
                  title:
                    text: "Temperature (°F)"
              xaxis:
                type: datetime
                labels:
                  datetimeUTC: false
              tooltip:
                shared: true
                x:
                  format: "HH:mm:ss"
              legend:
                show: true
                position: top
              grid:
                borderColor: var(--divider-color)
                strokeDashArray: 2
            series:
              - entity: sensor.gundergrill_temperature
                name: Temperature
                color: "#FF9800"
                stroke_width: 3
                curve: smooth
                yaxis_id: temp
                group_by:
                  func: avg
                  duration: 30s
              - entity: sensor.gundergrill_setpoint
                name: Setpoint
                color: "#4CAF50"
                stroke_width: 2
                curve: stepline
                yaxis_id: temp
                opacity: 0.7
                group_by:
                  func: last
                  duration: 30s

      # =====================================================================
      # SECTION 4: CONTROLS
      # =====================================================================
      - title: Controls
        type: grid
        cards:

          # Start button
          - type: custom:button-card
            name: START
            icon: mdi:play-circle
            tap_action:
              action: perform-action
              perform_action: script.gundergrill_start
            styles:
              card:
                - height: 80px
                - background: >
                    [[[
                      let state = states['sensor.gundergrill_state'].state;
                      return (state === 'Idle' || state === 'Shutdown')
                        ? 'linear-gradient(135deg, #2E7D32, #4CAF50)'
                        : 'var(--card-background-color)';
                    ]]]
                - color: >
                    [[[
                      let state = states['sensor.gundergrill_state'].state;
                      return (state === 'Idle' || state === 'Shutdown')
                        ? 'white' : 'var(--disabled-text-color)';
                    ]]]
                - border-radius: 12px
                - font-weight: bold
              icon:
                - width: 28px
              name:
                - font-size: 16px
                - letter-spacing: 2px

          # Stop button
          - type: custom:button-card
            name: STOP
            icon: mdi:stop-circle
            tap_action:
              action: perform-action
              perform_action: script.gundergrill_stop
              confirmation:
                text: "Stop the smoker and begin cooldown?"
            styles:
              card:
                - height: 80px
                - background: >
                    [[[
                      let state = states['sensor.gundergrill_state'].state;
                      return (state === 'Running' || state === 'Startup')
                        ? 'linear-gradient(135deg, #C62828, #F44336)'
                        : 'var(--card-background-color)';
                    ]]]
                - color: >
                    [[[
                      let state = states['sensor.gundergrill_state'].state;
                      return (state === 'Running' || state === 'Startup')
                        ? 'white' : 'var(--disabled-text-color)';
                    ]]]
                - border-radius: 12px
                - font-weight: bold
              icon:
                - width: 28px
              name:
                - font-size: 16px
                - letter-spacing: 2px

          # Quick-start presets
          - type: horizontal-stack
            cards:
              - type: custom:button-card
                name: "225°F"
                icon: mdi:grill
                tap_action:
                  action: perform-action
                  perform_action: script.gundergrill_quick_225
                styles:
                  card:
                    - height: 64px
                    - border-radius: 12px
                  icon:
                    - width: 22px
                    - color: "#FF9800"
                  name:
                    - font-size: 13px
                    - font-weight: bold

              - type: custom:button-card
                name: "250°F"
                icon: mdi:grill
                tap_action:
                  action: perform-action
                  perform_action: script.gundergrill_quick_250
                styles:
                  card:
                    - height: 64px
                    - border-radius: 12px
                  icon:
                    - width: 22px
                    - color: "#FF5722"
                  name:
                    - font-size: 13px
                    - font-weight: bold

              - type: custom:button-card
                name: "275°F"
                icon: mdi:grill
                tap_action:
                  action: perform-action
                  perform_action: script.gundergrill_quick_275
                styles:
                  card:
                    - height: 64px
                    - border-radius: 12px
                  icon:
                    - width: 22px
                    - color: "#F44336"
                  name:
                    - font-size: 13px
                    - font-weight: bold

          # Start temperature input
          - type: custom:mushroom-number-card
            entity: input_number.gundergrill_start_temp
            name: "Start Temperature"
            icon: mdi:thermometer-plus
            display_mode: buttons
            layout: horizontal

      # =====================================================================
      # SECTION 5: HARDWARE STATUS
      # =====================================================================
      - title: Hardware
        type: grid
        cards:

          # Auger
          - type: custom:mushroom-entity-card
            entity: binary_sensor.gundergrill_auger
            name: Auger
            icon: mdi:screw-lag
            layout: horizontal
            card_mod:
              style: |
                ha-card {
                  {% if is_state('binary_sensor.gundergrill_auger', 'on') %}
                    --card-primary-color: #FF9800;
                  {% endif %}
                }
                {% if is_state('binary_sensor.gundergrill_auger', 'on') %}
                mushroom-shape-icon {
                  --shape-animation: spin 1s linear infinite;
                }
                {% endif %}

          # Fan
          - type: custom:mushroom-entity-card
            entity: binary_sensor.gundergrill_fan
            name: Fan
            icon: mdi:fan
            layout: horizontal
            card_mod:
              style: |
                ha-card {
                  {% if is_state('binary_sensor.gundergrill_fan', 'on') %}
                    --card-primary-color: #2196F3;
                  {% endif %}
                }
                {% if is_state('binary_sensor.gundergrill_fan', 'on') %}
                mushroom-shape-icon {
                  --shape-animation: spin 0.5s linear infinite;
                }
                {% endif %}

          # Igniter
          - type: custom:mushroom-entity-card
            entity: binary_sensor.gundergrill_igniter
            name: Igniter
            icon: mdi:fire
            layout: horizontal
            card_mod:
              style: |
                ha-card {
                  {% if is_state('binary_sensor.gundergrill_igniter', 'on') %}
                    --card-primary-color: #F44336;
                  {% endif %}
                }
                {% if is_state('binary_sensor.gundergrill_igniter', 'on') %}
                mushroom-shape-icon {
                  --shape-animation: pulse 0.8s ease-in-out infinite;
                }
                {% endif %}

          # State machine status
          - type: custom:mushroom-entity-card
            entity: sensor.gundergrill_state
            name: State
            layout: horizontal
            card_mod:
              style: |
                ha-card {
                  {% set state = states('sensor.gundergrill_state') %}
                  {% if state == 'Running' %}
                    --card-primary-color: #4CAF50;
                  {% elif state == 'Startup' %}
                    --card-primary-color: #FF9800;
                  {% elif state == 'Error' %}
                    --card-primary-color: #F44336;
                  {% elif state == 'Cooldown' %}
                    --card-primary-color: #2196F3;
                  {% endif %}
                }

      # =====================================================================
      # SECTION 6: PID PERFORMANCE
      # =====================================================================
      - title: PID Controller
        type: grid
        cards:

          # PID Output gauge
          - type: gauge
            entity: sensor.gundergrill_pid_output
            name: Auger Duty Cycle
            unit: "%"
            min: 0
            max: 100
            needle: true
            severity:
              green: 15
              yellow: 60
              red: 85
            card_mod:
              style: |
                ha-card {
                  --ha-card-border-width: 0;
                }

          # PID terms chart
          - type: custom:apexcharts-card
            header:
              show: true
              title: PID Terms
              show_states: true
              colorize_states: true
            graph_span: 30min
            apex_config:
              chart:
                height: 200
              stroke:
                width: 2
                curve: smooth
              yaxis:
                - title:
                    text: Value
                  decimalsInFloat: 3
              legend:
                show: true
                position: top
            series:
              - entity: sensor.gundergrill_pid_proportional
                name: P
                color: "#2196F3"
                stroke_width: 2
                group_by:
                  func: avg
                  duration: 30s
              - entity: sensor.gundergrill_pid_integral
                name: I
                color: "#4CAF50"
                stroke_width: 2
                group_by:
                  func: avg
                  duration: 30s
              - entity: sensor.gundergrill_pid_derivative
                name: D
                color: "#FF9800"
                stroke_width: 2
                group_by:
                  func: avg
                  duration: 30s

          # PID Output history
          - type: custom:mini-graph-card
            entities:
              - entity: sensor.gundergrill_pid_output
                name: Output %
                color: "#FF9800"
            hours_to_show: 1
            points_per_hour: 120
            line_width: 2
            smoothing: true
            show:
              name: true
              icon: true
              state: true
              graph: line
              fill: true
              labels: hover
              extrema: true
            color_thresholds:
              - value: 15
                color: "#4CAF50"
              - value: 50
                color: "#FF9800"
              - value: 80
                color: "#F44336"

      # =====================================================================
      # SECTION 7: SYSTEM INFO
      # =====================================================================
      - title: System
        type: grid
        cards:

          - type: custom:mushroom-entity-card
            entity: sensor.gundergrill_uptime_formatted
            name: "Uptime"
            icon: mdi:clock-outline
            layout: horizontal

          - type: custom:mushroom-entity-card
            entity: sensor.gundergrill_wifi_quality
            name: "WiFi Quality"
            icon: mdi:wifi
            layout: horizontal
            card_mod:
              style: |
                ha-card {
                  {% set q = states('sensor.gundergrill_wifi_quality') | int(0) %}
                  {% if q > 70 %}
                    --card-primary-color: #4CAF50;
                  {% elif q > 40 %}
                    --card-primary-color: #FF9800;
                  {% else %}
                    --card-primary-color: #F44336;
                  {% endif %}
                }

          - type: custom:mushroom-entity-card
            entity: sensor.gundergrill_wifi_signal
            name: "WiFi RSSI"
            icon: mdi:signal
            layout: horizontal

          - type: custom:mushroom-entity-card
            entity: sensor.gundergrill_free_memory
            name: "Free Memory"
            icon: mdi:memory
            layout: horizontal

          # Notification toggle
          - type: custom:mushroom-entity-card
            entity: input_boolean.gundergrill_notifications
            name: "Notifications"
            icon: mdi:bell
            layout: horizontal
            tap_action:
              action: toggle

          # Web interface link
          - type: custom:button-card
            name: "Open Web UI"
            icon: mdi:web
            tap_action:
              action: url
              url_path: "http://esp32-smoker.local"
            styles:
              card:
                - height: 56px
                - border-radius: 12px
              icon:
                - width: 22px
                - color: "#2196F3"
              name:
                - font-size: 13px

  # =======================================================================
  # VIEW 2: LONG COOK SESSION
  # =======================================================================
  - title: Session
    path: session
    icon: mdi:chart-timeline-variant
    type: sections
    max_columns: 2
    cards: []
    sections:

      - title: Full Cook Session
        type: grid
        cards:

          # Extended temperature chart (24h)
          - type: custom:apexcharts-card
            header:
              show: true
              title: "24-Hour Temperature History"
              show_states: true
              colorize_states: true
            graph_span: 24h
            apex_config:
              chart:
                height: 400
              stroke:
                width:
                  - 2
                  - 2
                  - 1
                curve:
                  - smooth
                  - stepline
                  - smooth
              yaxis:
                - id: temp
                  min: 50
                  max: 500
                  decimalsInFloat: 0
                  title:
                    text: "Temperature (°F)"
                - id: pid
                  opposite: true
                  min: 0
                  max: 100
                  decimalsInFloat: 0
                  title:
                    text: "PID Output (%)"
              xaxis:
                type: datetime
                labels:
                  datetimeUTC: false
                  format: "HH:mm"
              tooltip:
                shared: true
                x:
                  format: "HH:mm:ss"
              legend:
                show: true
                position: top
              annotations:
                yaxis:
                  - y: 150
                    y2: 500
                    yAxisIndex: 0
                    borderColor: transparent
                    fillColor: "#4CAF50"
                    opacity: 0.03
                    label:
                      text: "Cook Zone"
                      position: "front"
                      style:
                        color: "#4CAF50"
                        fontSize: "11px"
            series:
              - entity: sensor.gundergrill_temperature
                name: Temperature
                color: "#FF9800"
                stroke_width: 2
                yaxis_id: temp
                group_by:
                  func: avg
                  duration: 2min
              - entity: sensor.gundergrill_setpoint
                name: Setpoint
                color: "#4CAF50"
                stroke_width: 2
                curve: stepline
                yaxis_id: temp
                opacity: 0.7
                group_by:
                  func: last
                  duration: 2min
              - entity: sensor.gundergrill_pid_output
                name: PID Output
                color: "#9C27B0"
                stroke_width: 1
                yaxis_id: pid
                opacity: 0.5
                group_by:
                  func: avg
                  duration: 2min

      - title: Session Statistics
        type: grid
        cards:

          - type: custom:mushroom-entity-card
            entity: sensor.gundergrill_temperature
            name: "Current Temp"
            layout: vertical
            primary_info: state
            secondary_info: name

          - type: custom:mushroom-entity-card
            entity: sensor.gundergrill_setpoint
            name: "Target Temp"
            layout: vertical
            primary_info: state
            secondary_info: name

          - type: custom:mushroom-entity-card
            entity: sensor.gundergrill_temperature_delta
            name: "Temp Delta"
            layout: vertical
            primary_info: state
            secondary_info: name

          - type: custom:mushroom-entity-card
            entity: sensor.gundergrill_pid_output
            name: "PID Output"
            layout: vertical
            primary_info: state
            secondary_info: name

          - type: custom:mushroom-entity-card
            entity: sensor.gundergrill_state
            name: "State"
            layout: vertical
            primary_info: state
            secondary_info: name

          - type: custom:mushroom-entity-card
            entity: sensor.gundergrill_uptime_formatted
            name: "Uptime"
            layout: vertical
            primary_info: state
            secondary_info: name

          # WiFi signal history
          - type: custom:mini-graph-card
            entities:
              - entity: sensor.gundergrill_wifi_signal
                name: WiFi RSSI
                color: "#2196F3"
            hours_to_show: 24
            points_per_hour: 2
            line_width: 2
            show:
              name: true
              icon: true
              state: true
              graph: line
              fill: true
              labels: hover
            color_thresholds:
              - value: -80
                color: "#F44336"
              - value: -65
                color: "#FF9800"
              - value: -50
                color: "#4CAF50"

  # =======================================================================
  # VIEW 3: DIAGNOSTICS
  # =======================================================================
  - title: Diagnostics
    path: diagnostics
    icon: mdi:wrench
    type: sections
    max_columns: 2
    cards: []
    sections:

      - title: PID Tuning
        type: grid
        cards:

          # Detailed PID chart
          - type: custom:apexcharts-card
            header:
              show: true
              title: "PID Analysis"
              show_states: true
              colorize_states: true
            graph_span: 2h
            apex_config:
              chart:
                height: 350
              stroke:
                width: 2
                curve: smooth
              yaxis:
                - id: terms
                  title:
                    text: "PID Term Value"
                  decimalsInFloat: 4
              legend:
                show: true
                position: top
              tooltip:
                shared: true
            series:
              - entity: sensor.gundergrill_pid_proportional
                name: "Proportional (P)"
                color: "#2196F3"
                yaxis_id: terms
                group_by:
                  func: avg
                  duration: 30s
              - entity: sensor.gundergrill_pid_integral
                name: "Integral (I)"
                color: "#4CAF50"
                yaxis_id: terms
                group_by:
                  func: avg
                  duration: 30s
              - entity: sensor.gundergrill_pid_derivative
                name: "Derivative (D)"
                color: "#FF9800"
                yaxis_id: terms
                group_by:
                  func: avg
                  duration: 30s

          # Temperature error band analysis
          - type: custom:apexcharts-card
            header:
              show: true
              title: "Temperature Error"
              show_states: false
            graph_span: 2h
            apex_config:
              chart:
                height: 200
              stroke:
                width: 2
                curve: smooth
              yaxis:
                - title:
                    text: "Error (°F)"
                  decimalsInFloat: 1
              annotations:
                yaxis:
                  - y: -5
                    y2: 5
                    borderColor: transparent
                    fillColor: "#4CAF50"
                    opacity: 0.1
                    label:
                      text: "±5°F"
            series:
              - entity: sensor.gundergrill_temperature_delta
                name: "Temp - Setpoint"
                color: "#FF5722"
                group_by:
                  func: avg
                  duration: 30s

      - title: System Diagnostics
        type: grid
        cards:

          # Memory usage over time
          - type: custom:mini-graph-card
            entities:
              - entity: sensor.gundergrill_free_memory
                name: Free Heap
                color: "#9C27B0"
            hours_to_show: 24
            points_per_hour: 2
            line_width: 2
            show:
              name: true
              icon: true
              state: true
              graph: line
              fill: true

          # All entity states table
          - type: entities
            title: "All GunderGrill Entities"
            show_header_toggle: false
            entities:
              - entity: sensor.gundergrill_temperature
              - entity: sensor.gundergrill_setpoint
              - entity: sensor.gundergrill_state
              - entity: binary_sensor.gundergrill_auger
              - entity: binary_sensor.gundergrill_fan
              - entity: binary_sensor.gundergrill_igniter
              - entity: sensor.gundergrill_pid_output
              - entity: sensor.gundergrill_pid_proportional
              - entity: sensor.gundergrill_pid_integral
              - entity: sensor.gundergrill_pid_derivative
              - entity: sensor.gundergrill_wifi_signal
              - entity: sensor.gundergrill_uptime
              - entity: sensor.gundergrill_free_memory
              - entity: number.gundergrill_target_temperature
              - type: divider
              - entity: input_number.gundergrill_start_temp
              - entity: input_boolean.gundergrill_notifications
              - entity: sensor.gundergrill_temperature_delta
              - entity: sensor.gundergrill_uptime_formatted
              - entity: sensor.gundergrill_wifi_quality

          # ESP32 Web UI iframe
          - type: iframe
            url: "http://esp32-smoker.local"
            aspect_ratio: "4:3"
            title: "GunderGrill Web UI"
