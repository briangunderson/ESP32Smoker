<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GunderGrill</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-left">
                <h1>GunderGrill</h1>
                <div class="connection-bar">
                    <span class="conn-dot" id="conn-wifi" title="WiFi"></span>
                    <span class="conn-label" id="conn-wifi-label">WiFi</span>
                    <span class="conn-dot" id="conn-api" title="API"></span>
                    <span class="conn-label" id="conn-api-label">API</span>
                </div>
            </div>
            <div class="state-badge" id="state-badge">Idle</div>
        </header>

        <nav class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab-btn" onclick="switchTab('pid')">PID Visualizer</button>
        </nav>

        <main id="tab-dashboard" class="tab-panel active">
            <!-- Temperature Hero -->
            <section class="temp-hero">
                <div class="temp-block temp-current">
                    <div class="temp-ring" id="temp-ring">
                        <svg viewBox="0 0 120 120">
                            <circle class="ring-bg" cx="60" cy="60" r="52" />
                            <circle class="ring-fill" id="ring-fill" cx="60" cy="60" r="52" />
                        </svg>
                        <div class="temp-value">
                            <span id="current-temp">--</span>
                            <span class="temp-unit">째F</span>
                        </div>
                    </div>
                    <div class="temp-label">Current</div>
                </div>
                <div class="temp-block temp-target">
                    <div class="temp-ring target">
                        <svg viewBox="0 0 120 120">
                            <circle class="ring-bg" cx="60" cy="60" r="52" />
                        </svg>
                        <div class="temp-value">
                            <span id="setpoint-temp">225</span>
                            <span class="temp-unit">째F</span>
                        </div>
                    </div>
                    <div class="temp-label">Target</div>
                </div>
            </section>

            <!-- Temperature Graph -->
            <section class="card graph-card">
                <div class="graph-header">
                    <h3>Temperature History</h3>
                    <div class="graph-range-btns" id="graph-range-btns">
                        <button onclick="setGraphRange(3600)">1h</button>
                        <button class="active" onclick="setGraphRange(14400)">4h</button>
                        <button onclick="setGraphRange(28800)">8h</button>
                        <button onclick="setGraphRange(43200)">12h</button>
                        <button onclick="setGraphRange(0)">All</button>
                    </div>
                </div>
                <canvas id="temp-graph"></canvas>
                <div class="graph-legend">
                    <span class="legend-item"><span class="legend-swatch temp"></span>Temp</span>
                    <span class="legend-item"><span class="legend-swatch setpoint"></span>Setpoint</span>
                    <span class="legend-item"><span class="legend-swatch event"></span>State Change</span>
                </div>
            </section>

            <!-- Controls -->
            <section class="card controls-card">
                <div class="control-row">
                    <button id="btn-start" class="btn btn-start" onclick="startSmoking()">Start</button>
                    <button id="btn-stop" class="btn btn-stop" onclick="stopSmoking()" disabled>Stop</button>
                    <button id="btn-shutdown" class="btn btn-shutdown" onclick="doShutdown()">Shutdown</button>
                </div>
                <div class="setpoint-row">
                    <button class="btn-adj" onclick="adjSetpoint(-5)">-</button>
                    <input type="number" id="setpoint-input" min="150" max="500" value="225" step="5">
                    <span class="sp-unit">째F</span>
                    <button class="btn-adj" onclick="adjSetpoint(5)">+</button>
                    <button class="btn btn-apply" onclick="applySetpoint()">Set</button>
                </div>
            </section>

            <!-- Relays & Info Row -->
            <div class="info-row">
                <section class="card relay-card">
                    <h3>Relays</h3>
                    <div class="relay-grid">
                        <div class="relay" id="relay-auger">
                            <div class="relay-led"></div>
                            <span>Auger</span>
                        </div>
                        <div class="relay" id="relay-fan">
                            <div class="relay-led"></div>
                            <span>Fan</span>
                        </div>
                        <div class="relay" id="relay-igniter">
                            <div class="relay-led"></div>
                            <span>Igniter</span>
                        </div>
                    </div>
                </section>
                <section class="card info-card">
                    <h3>Info</h3>
                    <div class="info-list">
                        <div class="info-row-item">
                            <span>Runtime</span><span id="runtime">0:00</span>
                        </div>
                        <div class="info-row-item">
                            <span>Errors</span><span id="error-count">0</span>
                        </div>
                        <div class="info-row-item">
                            <span>Heap</span><span id="heap-free">--</span>
                        </div>
                        <div class="info-row-item">
                            <span>Firmware</span><span id="fw-version">--</span>
                        </div>
                        <div class="info-row-item hidden" id="update-row">
                            <span>Update</span>
                            <span><span id="update-version"></span> <button class="btn-sm btn-on" onclick="applyUpdate()">Install</button></span>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Debug Panel -->
            <section class="card debug-card">
                <h3 class="debug-header" onclick="toggleDebug()">
                    Debug / Testing <span id="debug-arrow">&#9662;</span>
                </h3>
                <div id="debug-panel" class="debug-panel hidden">
                    <div class="debug-warn">Debug mode disables automatic temperature control.</div>
                    <div class="debug-btn-row">
                        <button id="btn-debug" class="btn btn-debug" onclick="toggleDebugMode()">Enable Debug Mode</button>
                        <button id="btn-reset-error" class="btn btn-reset hidden" onclick="resetError()">Reset Error</button>
                        <button class="btn btn-debug" onclick="checkForUpdate()">Check for Updates</button>
                        <button id="btn-fast-ota" class="btn btn-debug" onclick="toggleFastOta()">Fast OTA: Off</button>
                    </div>
                    <div id="debug-controls" class="hidden">
                        <h4>Manual Relay Control</h4>
                        <div class="relay-ctrl-grid">
                            <div class="relay-ctrl">
                                <span>Auger</span>
                                <button class="btn-sm btn-on" onclick="setRelay('auger',true)">ON</button>
                                <button class="btn-sm btn-off" onclick="setRelay('auger',false)">OFF</button>
                            </div>
                            <div class="relay-ctrl">
                                <span>Fan</span>
                                <button class="btn-sm btn-on" onclick="setRelay('fan',true)">ON</button>
                                <button class="btn-sm btn-off" onclick="setRelay('fan',false)">OFF</button>
                            </div>
                            <div class="relay-ctrl">
                                <span>Igniter</span>
                                <button class="btn-sm btn-on" onclick="setRelay('igniter',true)">ON</button>
                                <button class="btn-sm btn-off" onclick="setRelay('igniter',false)">OFF</button>
                            </div>
                        </div>
                        <h4>Temperature Override</h4>
                        <div class="override-row">
                            <input type="number" id="temp-override" min="0" max="600" value="225" placeholder="째F">
                            <button class="btn btn-apply" onclick="setTempOverride()">Set</button>
                            <button class="btn btn-stop" onclick="clearTempOverride()">Clear</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <div id="tab-pid" class="tab-panel" style="display:none;">
            <!-- Animated Smoker Cross-Section -->
            <section class="card smoker-scene-card">
                <h3>How Your Smoker Works</h3>
                <canvas id="smoker-scene"></canvas>
                <div class="smoker-legend">
                    <span><span class="legend-swatch" style="background:#ff6b35"></span>Fire</span>
                    <span><span class="legend-swatch" style="background:#aaa"></span>Smoke</span>
                    <span><span class="legend-swatch" style="background:#8B6914"></span>Pellets</span>
                    <span><span class="legend-swatch" style="background:#3498db"></span>Air</span>
                </div>
            </section>

            <!-- PID Brain: Three Visual Metaphors -->
            <section class="card pid-brain-card">
                <h3>The PID Brain</h3>
                <div class="pid-brain-row">
                    <div class="brain-col">
                        <canvas id="pid-spring"></canvas>
                        <span class="brain-label" style="color:#3498db">Proportional</span>
                        <span class="brain-desc">How far am I from target?</span>
                    </div>
                    <div class="brain-col">
                        <canvas id="pid-bucket"></canvas>
                        <span class="brain-label" style="color:#2ecc71">Integral</span>
                        <span class="brain-desc">How long have I been off?</span>
                    </div>
                    <div class="brain-col">
                        <canvas id="pid-speedo"></canvas>
                        <span class="brain-label" style="color:#ff6b35">Derivative</span>
                        <span class="brain-desc">How fast am I changing?</span>
                    </div>
                </div>
            </section>

            <!-- Feedback Loop Flow -->
            <section class="card feedback-card">
                <canvas id="feedback-loop"></canvas>
            </section>

            <!-- PID Time Series Chart (retained) -->
            <section class="card pid-chart-card">
                <div class="graph-header">
                    <h3>PID History</h3>
                    <div class="graph-range-btns" id="pid-range-btns">
                        <button class="active" onclick="setPidRange(120)">2m</button>
                        <button onclick="setPidRange(300)">5m</button>
                        <button onclick="setPidRange(600)">10m</button>
                    </div>
                </div>
                <canvas id="pid-history-chart"></canvas>
                <div class="graph-legend">
                    <span class="legend-item"><span class="legend-swatch" style="background:#3498db"></span>P</span>
                    <span class="legend-item"><span class="legend-swatch" style="background:#2ecc71"></span>I</span>
                    <span class="legend-item"><span class="legend-swatch" style="background:#ff6b35"></span>D</span>
                    <span class="legend-item"><span class="legend-swatch" style="background:#fff"></span>Output</span>
                    <span class="legend-item"><span class="legend-swatch" style="background:#e74c3c;opacity:.6"></span>Temp</span>
                </div>
            </section>
        </div>

        <footer>GunderGrill <span id="fw-footer-version">v1.2.0</span></footer>
    </div>

    <!-- Toast container -->
    <div id="toasts"></div>

    <script src="script.js"></script>
</body>
</html>
